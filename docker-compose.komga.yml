version: "3.9"

services:
  komga:
    image: ghcr.io/gotson/komga:1.23.6
    container_name: komga
    environment:
      - JAVA_OPTS=-Xms4g -Xmx8g
      # Spring-style 6â€‘field cron; hourly scan to keep metadata fresh
      - KOMGA_LIBRARIES_SCAN_CRON=0 0 * * * *
      # Allow Komf UI (default 8085) to make CORS calls into Komga
      - KOMGA_CORS_ALLOWED_ORIGINS=http://localhost:8085
    volumes:
      # Comics library (rw for shared tooling)
      - ${COMICS_ROOT:-/srv/usenet/books/Comics}:/comics:rw,Z
      # Persistent config/db
      - ${CONFIG_ROOT:-/srv/usenet/config}/komga:/config:rw,Z
      # Temp dir (thumbnail extraction)
      - ${KOMGA_TMP:-/srv/usenet/config/komga/tmp}:/tmp:rw,Z
    ports:
      - "${KOMGA_PORT:-8081}:25600"
    restart: unless-stopped

  komf:
    image: docker.io/sndxr/komf:1.3.0
    container_name: komf
    environment:
      # Point Komf at Komga; override if running remotely
      - KOMGA_BASE_URI=http://komga:25600
    volumes:
      - ${CONFIG_ROOT:-/srv/usenet/config}/komf:/config:rw,Z
    depends_on:
      - komga
    ports:
      - "${KOMF_PORT:-8085}:8085"
    restart: unless-stopped

  kavita:
    image: jvmilazz0/kavita:latest
    container_name: kavita
    environment:
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/srv/usenet/config}/kavita:/kavita/config:rw,Z
      - ${COMICS_ROOT:-/srv/usenet/books/Comics}:/comics:rw,Z
      - ${EBOOKS_ROOT:-/srv/usenet/books/Ebooks}:/books:rw,Z
    ports:
      - "${KAVITA_PORT:-5000}:5000"
    restart: unless-stopped

  suwayomi:
    image: ghcr.io/suwayomi/suwayomi-server:stable
    container_name: suwayomi
    environment:
      - TZ=Etc/UTC
    volumes:
      # Order matters: downloads first per Suwayomi docker docs
      - ${COMICS_ROOT:-/srv/usenet/books/Comics}/Manga:/home/suwayomi/.local/share/Tachidesk/downloads:rw,Z
      - ${CONFIG_ROOT:-/srv/usenet/config}/suwayomi:/home/suwayomi/.local/share/Tachidesk:rw,Z
    ports:
      - "${SUWAYOMI_PORT:-4567}:4567"
    restart: unless-stopped

networks:
  default:
    name: komga_net
