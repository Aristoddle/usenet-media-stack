x-logging: &id001
  driver: json-file
  options:
    max-size: 50m
    max-file: '3'
volumes:
  portainer_data:
    driver: local
services:
  samba:
    image: dperson/samba:latest
    container_name: samba
    logging: *id001
    hostname: media-server
    ports:
      - 139:139
      - 445:445
    environment:
      - TZ=Etc/UTC
      - USERID=1000
      - GROUPID=1000
    command: '-u "joe;joe"  -s "Media;/media;yes;no;no;joe;joe;joe"  -s "Downloads;/downloads;yes;no;no;joe;joe;joe" -s "TV;/tv;yes;no;no;joe;joe;joe" -s "Movies;/movies;yes;no;no;joe;joe;joe" -s "Books;/books;yes;no;no;joe;joe;joe" -s "Comics;/comics;yes;no;no;joe;joe;joe" -s "Config;/config;yes;no;no;joe;joe;joe" -p -w "WORKGROUP" -n

'
    volumes:
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}:/media:rw
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads:rw
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}:/config:rw
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv:rw
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/movies:/movies:rw
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
          - node.labels.storage == true
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test:
        - CMD
        - smbclient
        - -L
        - localhost
        - -U
        - '%'
      interval: 30s
      timeout: 10s
      retries: 3
  nfs-server:
    image: erichough/nfs-server:latest
    logging: *id001
    container_name: nfs-server
    hostname: nfs-server
    ports:
      - 2049:2049
      - 111:111
      - 111:111/udp
      - 32765:32765
      - 32767:32767/udp
    cap_add:
      - SYS_ADMIN
    privileged: true
    volumes:
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}:/media:rw
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads:rw
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}:/config:rw
    environment:
      - SHARED_DIRECTORY=/media
      - SHARED_DIRECTORY_2=/downloads
      - SHARED_DIRECTORY_3=/config
      - SYNC=true
      - PERMITTED=192.168.0.0/16
      - NFS_EXPORT_0=/media *(rw,sync,no_subtree_check,no_root_squash)
      - NFS_EXPORT_1=/downloads *(rw,sync,no_subtree_check,no_root_squash)
    restart: unless-stopped
    deploy:
      replicas: 0
  netdata:
    image: netdata/netdata:stable
    container_name: netdata
    hostname: netdata-media-server
    ports:
      - 19999:19999
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - /proc:/host/proc:rw
      - /sys:/host/sys:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /etc/passwd:/host/etc/passwd:rw
      - /etc/group:/host/etc/group:rw
    environment:
      - DOCKER_HOST=/var/run/docker.sock
    restart: unless-stopped
    deploy:
      mode: global
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options: &id002
        max-size: 50m
        max-file: '3'
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - 9000:9000
      - 8000:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options: *id002
  sabnzbd:
    image: docker.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    hostname: sabnzbd
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/sabnzbd:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
    ports:
      - 8080:8080
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.performance == high
          - node.labels.storage == true
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8080
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  transmission:
    image: docker.io/linuxserver/transmission:latest
    container_name: transmission
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
    - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/transmission:/config
    - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
    - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}/watch:/watch
    ports:
    - 9091:9091
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.performance == high
          - node.labels.storage == true
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: json-file
      options: *id002
  sonarr:
    image: docker.io/linuxserver/sonarr:latest
    container_name: sonarr
    hostname: sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/sonarr:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv:rw
    ports:
      - 8989:8989
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    depends_on:
      - sabnzbd
      - transmission
    logging:
      driver: json-file
      options: *id002
  radarr:
    image: docker.io/linuxserver/radarr:latest
    container_name: radarr
    hostname: radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/radarr:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/movies:/movies:rw
    ports:
      - 7878:7878
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    depends_on:
      - sabnzbd
      - transmission
    logging:
      driver: json-file
      options: *id002
  bazarr:
    image: docker.io/linuxserver/bazarr:latest
    container_name: bazarr
    hostname: bazarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/bazarr:/config
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv:rw
    ports:
      - 6767:6767
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    depends_on:
      - sonarr
      - radarr
    logging:
      driver: json-file
      options: *id002
  prowlarr:
    image: docker.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    hostname: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/prowlarr:/config
    ports:
      - 9696:9696
    dns:
      - 1.1.1.1
      - 1.0.0.1
    dns_opt:
      - use-vc
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.default.disable_ipv6=1
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.performance != low
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options: *id002
  whisparr:
    image: docker.io/thespad/whisparr:latest
    container_name: whisparr
    hostname: whisparr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/whisparr:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/movies:/movies
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv
    ports:
      - 6969:6969
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options: *id002
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    hostname: lidarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/lidarr:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
      - ${MUSIC_ROOT:-/var/mnt/fast8tb/Local/media/music}:/music:rw
    ports:
      - 8686:8686
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options: *id002
  mylar:
    image: docker.io/linuxserver/mylar3:latest
    container_name: mylar
    hostname: mylar
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/mylar:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
      - ${COMICS_ROOT:-/var/mnt/fast8tb/Cloud/OneDrive/Books/Comics}:/comics:rw,z
    ports:
      - 8090:8090
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options: *id002
  jellyfin:
    image: docker.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    hostname: jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - JELLYFIN_PublishedServerUrl=http://localhost:8096
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/jellyfin:/config
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}:/media
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/movies:/movies
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/music:/music
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/books:/books
    ports:
      - 8096:8096
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: json-file
      options: *id002
  overseerr:
    image: docker.io/linuxserver/overseerr:latest
    container_name: overseerr
    hostname: overseerr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/overseerr:/config
    ports:
      - 5055:5055
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options: *id002
  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    hostname: recyclarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/recyclarr:/config
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options: *id002
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    hostname: tdarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - TDARR_INSTANCE_NAME=Main
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - nodeID=MainNode
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/tdarr/server:/app/server
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/tdarr/configs:/app/configs
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/tdarr/logs:/app/logs
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}:/media
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/movies:/movies
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}/tdarr_transcode:/temp
    ports:
      - 8265:8265
      - 8266:8266
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: json-file
      options: *id002
  docs:
    image: nginx:alpine
    container_name: usenet-docs
    hostname: docs
    volumes:
      - ${STACK_ROOT:-.}/docs/.vitepress/dist:/usr/share/nginx/html:rw,z
    ports:
      - 4173:80
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 0
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://localhost:80
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  stash:
    image: stashapp/stash:latest
    container_name: stash
    hostname: stash
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - STASH_STASH=/data/
      - STASH_GENERATED=/generated/
      - STASH_METADATA=/metadata/
      - STASH_CACHE=/cache/
      - STASH_PORT=9999
    volumes:
      - /etc/localtime:/etc/localtime:rw
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/stash:/root/.stash:Z
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/adult:/data
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/stash/metadata:/metadata:Z
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/stash/cache:/cache:Z
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/stash/blobs:/blobs:Z
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/stash/generated:/generated:Z
      - ${MEDIA_ROOT:-/var/mnt/fast8tb/Local/media}/tv:/tv:rw
    ports:
      - 9998:9999
    restart: unless-stopped
    logging:
      driver: json-file
      options: *id002
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.storage == true
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
  komga:
    image: ghcr.io/gotson/komga:1.23.6
    container_name: komga
    user: 1000:1000
    security_opt:
      - label:disable
    logging: *id001
    environment:
      - JAVA_OPTS=-Xms4g -Xmx8g -Djava.io.tmpdir=/config/tmp
      - KOMGA_LIBRARIES_SCAN_CRON=0 0 * * * *
      - KOMGA_CORS_ALLOWED_ORIGINS=http://localhost:8085
    volumes:
      - ${COMICS_ROOT:-/var/mnt/fast8tb/Cloud/OneDrive/Books/Comics}:/comics:rw,z
      - ${COMICS_ROOT:-/var/mnt/fast8tb/Cloud/OneDrive/Books/Comics}:/comics_mirror:rw,z
      - /var/mnt/fast8tb/config/komga:/config:Z
    ports:
      - 8081:25600
    restart: unless-stopped
  komf:
    image: sndxr/komf:1.3.0
    container_name: komf
    logging: *id001
    environment:
      - KOMGA_BASE_URI=http://komga:25600
      - KOMF_COMICVINE_API_KEY=${KOMF_COMICVINE_API_KEY:-}
      - KOMF_MANGAUPDATES_USERNAME=${KOMF_MANGAUPDATES_USERNAME:-}
      - KOMF_MANGAUPDATES_PASSWORD=${KOMF_MANGAUPDATES_PASSWORD:-}
      - KOMF_MANGADEX_CLIENT_ID=${KOMF_MANGADEX_CLIENT_ID:-}
      - KOMF_MANGADEX_CLIENT_SECRET=${KOMF_MANGADEX_CLIENT_SECRET:-}
      - KOMF_ANILIST_CLIENT_ID=${KOMF_ANILIST_CLIENT_ID:-}
      - KOMF_ANILIST_CLIENT_SECRET=${KOMF_ANILIST_CLIENT_SECRET:-}
    volumes:
      - /var/home/deck/komf-config:/config:rw,z
      - ${COMICS_ROOT:-/var/mnt/fast8tb/Cloud/OneDrive/Books/Comics}:/comics:rw,z
    depends_on:
      - komga
    ports:
      - 8085:8085
    restart: unless-stopped
  kavita:
    image: jvmilazz0/kavita:latest
    container_name: kavita
    environment:
      - TZ=Etc/UTC
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/kavita:/kavita/config:rw,Z
      - ${COMICS_ROOT:-/var/mnt/fast8tb/Cloud/OneDrive/Books/Comics}:/comics:rw,z
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads:rw,z
    ports:
      - 5000:5000
    restart: unless-stopped
  aria2:
    build: ./aria2
    container_name: aria2
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - ARIA2_SECRET=${ARIA2_SECRET}
    volumes:
      - ${CONFIG_ROOT:-/var/mnt/fast8tb/config}/aria2:/config
      - ${DOWNLOADS_ROOT:-/var/mnt/fast8tb/Local/downloads}:/downloads
    ports:
      - 6800:6800
    restart: unless-stopped
